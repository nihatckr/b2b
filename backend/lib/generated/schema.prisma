// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  output        = "../lib/generated"
  binaryTargets = ["native", "darwin-arm64", "windows"]
}

generator pothos {
  provider     = "prisma-pothos-types"
  clientOutput = "./generated" // relative path from pothos output to prisma client
  output       = "../lib/pothos-prisma-types.ts"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN // Platform admin
  COMPANY_OWNER // Firma sahibi (hem üretici hem müşteri)
  COMPANY_EMPLOYEE // Firma çalışanı (hem üretici hem müşteri)
  INDIVIDUAL_CUSTOMER // Bireysel müşteri (firma olmadan)
}

enum CompanyType {
  MANUFACTURER // Üretici firma (Defacto)
  BUYER // Alıcı firma (LC Waikiki)
  BOTH // Her ikisi de (hem üretir hem alır)
}

// Department Enum - COMPANY_EMPLOYEE rolleri için
enum Department {
  PURCHASING // Satın Alma
  PRODUCTION // Üretim
  QUALITY // Kalite Kontrol
  DESIGN // Tasarım
  SALES // Satış
  MANAGEMENT // Yönetim
}

// Subscription Plan Enum
enum SubscriptionPlan {
  FREE // Ücretsiz plan (trial)
  STARTER // Başlangıç planı
  PROFESSIONAL // Profesyonel plan
  ENTERPRISE // Kurumsal plan
  CUSTOM // Özel anlaşma
}

// Subscription Status Enum
enum SubscriptionStatus {
  TRIAL // Deneme süresi
  ACTIVE // Aktif abonelik
  PAST_DUE // Ödeme gecikmiş
  CANCELLED // İptal edilmiş
  EXPIRED // Süresi dolmuş
}

// Billing Cycle Enum
enum BillingCycle {
  MONTHLY // Aylık
  YEARLY // Yıllık
}

enum Gender {
  WOMEN // Kadın
  MEN // Erkek
  GIRLS // Kız Çocuk
  BOYS // Erkek Çocuk
  UNISEX // Unisex
}

// ========================================
// RFQ (Request for Quotation) System Enums
// ========================================
enum CollectionOwnerType {
  MANUFACTURER // Üretici koleksiyonu (mevcut - hazır katalog)
  CUSTOMER // Müşteri koleksiyonu (yeni - RFQ/teklif talebi)
}

enum CollectionVisibility {
  PRIVATE // Sadece sahibi görür
  INVITED // Davet edilen üreticiler görür
  PUBLIC // Tüm üreticiler görür (marketplace)
}

enum RFQStatus {
  OPEN // Açık (teklifler bekleniyor)
  QUOTES_RECEIVED // Teklifler geldi
  UNDER_REVIEW // İnceleniyor
  WINNER_SELECTED // Kazanan seçildi
  CLOSED // Kapatıldı (iptal veya tamamlandı)
}

enum QuoteStatus {
  PENDING // Beklemede (müşteri henüz bakmadı)
  REVIEWED // Müşteri gördü
  SHORTLISTED // Kısa listeye alındı
  ACCEPTED // Kabul edildi (kazanan)
  REJECTED // Reddedildi
  EXPIRED // Süresi doldu
  WITHDRAWN // Üretici geri çekti
}

model Company {
  id          Int         @id @default(autoincrement())
  name        String
  email       String?     @unique
  phone       String?
  address     String?
  city        String? // Şehir: "İstanbul", "İzmir", "Denizli"
  country     String? // Ülke: "Turkey", "Germany", etc.
  location    String? // Deprecated - use city instead
  website     String?
  type        CompanyType @default(MANUFACTURER)
  description String?     @db.Text

  // Owner
  owner   User? @relation("CompanyOwner", fields: [ownerId], references: [id])
  ownerId Int?  @unique

  isActive Boolean @default(true)
  settings Json? // Company-wide settings

  // ========================================
  // SUBSCRIPTION SYSTEM
  // ========================================
  subscriptionPlan   SubscriptionPlan   @default(FREE)
  subscriptionStatus SubscriptionStatus @default(TRIAL)

  // Trial Period
  trialStartedAt DateTime? @default(now())
  trialEndsAt    DateTime? // 14 gün trial

  // Subscription Billing
  subscriptionStartedAt DateTime? // Ücretli abonelik başlangıcı
  currentPeriodStart    DateTime? // Mevcut dönem başlangıcı
  currentPeriodEnd      DateTime? // Mevcut dönem bitişi
  cancelAtPeriodEnd     Boolean      @default(false)
  cancelledAt           DateTime? // İptal tarihi
  billingCycle          BillingCycle @default(MONTHLY)
  billingEmail          String? // Fatura e-postası
  billingAddress        String?      @db.Text
  taxId                 String? // Vergi numarası

  // Usage Limits (Plan-based)
  maxUsers       Int   @default(3) // FREE: 3, STARTER: 10, PRO: 50, ENT: unlimited
  maxSamples     Int   @default(10) // FREE: 10, STARTER: 100, PRO: 500, ENT: unlimited
  maxOrders      Int   @default(5) // FREE: 5, STARTER: 50, PRO: 200, ENT: unlimited
  maxCollections Int   @default(5) // FREE: 5, STARTER: 20, PRO: 100, ENT: unlimited
  maxStorageGB   Float @default(1.0) // FREE: 1GB, STARTER: 10GB, PRO: 100GB, ENT: unlimited

  // Current Usage (auto-calculated)
  currentUsers       Int   @default(0)
  currentSamples     Int   @default(0)
  currentOrders      Int   @default(0)
  currentCollections Int   @default(0)
  currentStorageGB   Float @default(0.0)

  // ========================================
  // BRANDING & CUSTOMIZATION
  // ========================================
  logo        String? // Logo URL
  coverImage  String? // Kapak görseli URL
  brandColors Json? // { primary: "#xxx", secondary: "#xxx", accent: "#xxx" }

  // Public Profile (for manufacturers to showcase)
  profileSlug     String? @unique // URL-friendly slug: "defacto", "koton"
  isPublicProfile Boolean @default(false) // Herkese açık profil mi?
  socialLinks     Json? // { instagram: "...", linkedin: "...", website: "..." }

  // Dashboard Preferences
  defaultView    String? // "MANUFACTURER" | "BUYER" (for BOTH type companies)
  enabledModules Json? // { samples: true, orders: true, production: true, etc. }

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  employees          User[]               @relation("CompanyEmployees")
  collections        Collection[]
  samples            Sample[]
  orders             Order[]
  productionTracking ProductionTracking[]
  messages           Message[]

  // Library Management (Unified)
  libraryItems LibraryItem[] @relation("CompanyLibraryItems")

  // ✅ OPTIMIZED INDEXES
  @@index([email])
  @@index([type, isActive, createdAt]) // Composite: 3 query'yi kapsar
  @@index([subscriptionStatus, currentPeriodEnd]) // Subscription renewal check
  @@index([subscriptionPlan, subscriptionStatus]) // Subscription filtering
  @@index([profileSlug])
  @@index([isPublicProfile, type]) // Public profile listing
  @@index([ownerId])
  @@fulltext([name, description])
  @@map("companies")
}

model Message {
  id         Int     @id @default(autoincrement())
  content    String  @db.Text
  senderId   Int
  receiverId Int? // Alıcı kullanıcı ID
  isRead     Boolean @default(false)
  type       String  @default("general") // "order", "sample", "general"

  // Ürün bazlı mesajlaşma
  orderId  Int?
  sampleId Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver  User?    @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sample    Sample?  @relation(fields: [sampleId], references: [id], onDelete: Cascade)
  company   Company? @relation(fields: [companyId], references: [id])
  companyId Int?

  @@index([orderId])
  @@index([sampleId])
  @@index([senderId])
  @@index([receiverId])
  @@map("messages")
}

model ProductionTracking {
  id       Int  @id @default(autoincrement())
  orderId  Int? @unique // Her sipariş için tek plan
  sampleId Int? @unique // Her numune için tek plan

  currentStage  ProductionStage  @default(PLANNING)
  overallStatus ProductionStatus @default(IN_PROGRESS)
  progress      Int              @default(0) // 0-100%

  estimatedStartDate DateTime?
  estimatedEndDate   DateTime?
  actualStartDate    DateTime?
  actualEndDate      DateTime?

  notes String? @db.Text

  // ========================================
  // ÜRETİM PLANI MÜŞTERİ ONAYI (Production Plan Customer Approval)
  // ========================================
  // Plan durumu
  planStatus     ApprovalStatus @default(DRAFT) // DRAFT, PENDING, APPROVED, REJECTED, REVISION
  planSentAt     DateTime? // Plan müşteriye gönderildi
  planApprovedAt DateTime? // Müşteri onayladı
  planRejectedAt DateTime? // Müşteri reddetti

  // Müşteri geri bildirimi
  customerNote            String? @db.Text // Müşteri notu/talebi
  customerRejectionReason String? @db.Text // Red sebebi
  revisionCount           Int     @default(0) // Kaç kez revize edildi

  // Üretim başlama koşulu
  canStartProduction  Boolean   @default(false) // TRUE = Müşteri onayladı, üretim başlayabilir
  productionStartDate DateTime? // Fiili üretim başlangıç tarihi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  order     Order?   @relation(fields: [orderId], references: [id], onDelete: SetNull)
  sample    Sample?  @relation(fields: [sampleId], references: [id], onDelete: SetNull)
  company   Company? @relation(fields: [companyId], references: [id])
  companyId Int?

  stageUpdates  ProductionStageUpdate[]
  notifications Notification[]          @relation("ProductionNotifications")

  @@map("production_tracking")
}

model User {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  password  String
  name      String?
  username  String? @unique
  firstName String?
  lastName  String?
  phone     String?

  // Company & Role
  company   Company? @relation("CompanyEmployees", fields: [companyId], references: [id])
  companyId Int?
  role      Role     @default(INDIVIDUAL_CUSTOMER)

  // Company Ownership & Permissions
  isCompanyOwner Boolean     @default(false)
  department     Department? // Enum: PURCHASING, PRODUCTION, QUALITY, DESIGN, SALES, MANAGEMENT
  jobTitle       String? // "Müdür", "Uzman", "Koordinatör"
  permissions    Json? // Detaylı permission objesi

  // Status
  isActive          Boolean @default(true)
  isPendingApproval Boolean @default(false)

  // ========================================
  // USER PROFILE & SETTINGS
  // ========================================
  avatar       String? @db.Text // Profile picture URL from OAuth providers (GitHub/Google)
  customAvatar String? @db.Text // User's custom uploaded profile picture (overrides avatar)
  bio          String? @db.Text // User bio/description
  socialLinks  Json? // { twitter: "...", linkedin: "...", github: "..." }

  // Notification Settings
  emailNotifications Boolean @default(true)
  pushNotifications  Boolean @default(false)

  // Localization
  language String @default("tr") // "tr", "en"
  timezone String @default("Europe/Istanbul")

  // Password Reset
  resetToken       String? // Token for password reset
  resetTokenExpiry DateTime? // Token expiration date

  // Email Verification
  emailVerified           Boolean   @default(false) // Email doğrulandı mı?
  emailVerificationToken  String? // Email doğrulama token
  emailVerificationExpiry DateTime? // Token son kullanma tarihi

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Owned Companies
  ownedCompanies Company[] @relation("CompanyOwner")

  // Messages relation
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")

  // Category Management
  createdCategories Category[] @relation("CategoryCreator")

  collections Collection[]

  // Customer relations
  customerSamples   Sample[]   @relation("CustomerSamples")
  customerOrders    Order[]    @relation("CustomerOrders")
  customerQuestions Question[] @relation("CustomerQuestions")

  // Manufacture relations
  manufactureSamples      Sample[]           @relation("ManufactureSamples")
  manufactureOrders       Order[]            @relation("ManufactureOrders")
  manufactureQuestions    Question[]         @relation("ManufactureQuestions")
  sampleProductionUpdates SampleProduction[]
  orderProductionUpdates  OrderProduction[]  @relation("OrderProductionUpdates")

  // Notifications
  notifications Notification[] @relation("UserNotifications")

  // Unified Library Management (Admin)
  createdLibraryItems LibraryItem[] @relation("LibraryItemCreator")

  // Order Negotiations
  sentNegotiations      OrderNegotiation[] @relation("SentNegotiations")
  respondedNegotiations OrderNegotiation[] @relation("RespondedNegotiations")

  // Order change tracking
  orderChangesMade     OrderChangeLog[] @relation("OrderChangesMade")
  orderChangesReviewed OrderChangeLog[] @relation("OrderChangesReviewed")

  // RFQ System Relations
  manufacturerQuotes CollectionQuote[] @relation("ManufacturerQuotes") // Üreticinin verdiği teklifler
  wonRFQs            Collection[]      @relation("RFQWinner") // Kazandığı RFQ'ler

  // Rating/Review System Relations
  givenReviews    OrderReview[] @relation("CustomerReviews") // Müşteri olarak verdiği değerlendirmeler
  receivedReviews OrderReview[] @relation("ManufacturerReviews") // Üretici olarak aldığı değerlendirmeler

  @@index([email])
  @@index([companyId, role, isActive]) // 3 sorguyu kapsar
  @@index([companyId, department, isActive])
  @@index([createdAt])
  @@map("users")
}

// ========================================
// ADMIN-MANAGED CATEGORY SYSTEM FOR TEXTILE INDUSTRY
// Tek kategori sistemi: Admin tarafından yönetilen StandardCategory
// ========================================

enum CategoryLevel {
  ROOT // Ana kategori (Tekstil, Giyim, Aksesuar)
  MAIN // Ana grup (Üst Giyim, Alt Giyim, İç Giyim)
  SUB // Alt grup (Gömlek, Pantolon, Elbise)
  DETAIL // Detay (Uzun Kollu Gömlek, Kısa Kollu Gömlek)
}

// Platform Geneli Standart Kategori Ağacı (Admin yönetir)
model Category {
  id          Int     @id @default(autoincrement())
  code        String  @unique // "TEX-001", "GAR-001-001", "ACC-002"
  name        String // i18n key or direct name (frontend handles translations)
  description String? @db.Text // i18n key or direct description

  level CategoryLevel
  order Int           @default(0) // Sıralama için
  icon  String? // Icon URL veya code
  image String? // Kategori görseli

  isActive Boolean @default(true)
  isPublic Boolean @default(true) // Tüm firmalara açık mı?

  // Meta bilgiler
  keywords String? @db.Text // Arama için keywords (JSON array)
  tags     String? // "#gömlek #shirt #formal" gibi

  // İlişkiler
  parentCategory Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  parentId       Int?
  subCategories  Category[] @relation("CategoryTree")

  // Bu kategorideki koleksiyonlar
  collections Collection[] @relation("CollectionCategory")

  // Admin
  createdBy   User? @relation("CategoryCreator", fields: [createdById], references: [id])
  createdById Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([level])
  @@index([parentId])
  @@index([isActive, isPublic])
  @@index([order])
  @@fulltext([name, description, keywords])
  @@map("categories")
}

model Collection {
  id          Int      @id @default(autoincrement())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  name        String
  description String?  @db.Text

  // ADIM 1: Temel Bilgiler
  modelCode String @unique // THS-2024-00

  // Season (LibraryItem relation - Platform standardı)
  season   LibraryItem? @relation("CollectionSeason", fields: [seasonId], references: [id])
  seasonId Int?

  // klasman -> category ile handle edilecek (Gömlek, Pantolon, Triko)
  gender Gender? // Kadın, Erkek, Kız Çocuk, Erkek Çocuk

  // Fit (LibraryItem relation - Platform standardı + Ölçü tablosu)
  fit   LibraryItem? @relation("CollectionFit", fields: [fitId], references: [id])
  fitId Int?

  // Trend (LibraryItem relation - Platform standardı)
  trend   LibraryItem? @relation("CollectionTrend", fields: [trendId], references: [id])
  trendId Int?

  // ADIM 2: Varyantlar ve Ölçüler
  // Colors (Many-to-Many - Platform renk kataloğu: Pantone + HEX standardı)
  colors LibraryItem[] @relation("CollectionColors")

  // Size Groups (Many-to-Many - Platform beden grubu kataloğu: Men Upper EU, Women Lower US standardı)
  sizeGroups LibraryItem[] @relation("CollectionSizeGroups")

  // ADIM 3: Teknik Detaylar
  // Fabrics (Many-to-Many - Platform kumaş kataloğu: Fiber tipi + Weight + Certifications)
  fabrics LibraryItem[] @relation("CollectionFabrics")

  // Accessories (Many-to-Many - Platform aksesuar kataloğu: YKK, Button, Label standardı)
  accessories LibraryItem[] @relation("CollectionAccessories")

  images   String? @db.Text // JSON array: ["/uploads/products/img1.jpg", ...] or ["https://..."]
  techPack String? // File path: /uploads/techpacks/xxx.pdf

  // ADIM 4: Ticari Bilgiler
  moq            Int? // Minimum Order Quantity
  targetPrice    Float? // Hedef fiyat
  currency       String?   @default("USD") // Para birimi: USD, EUR, TRY
  targetLeadTime Int? // Hedef termin (gün)
  deadline       DateTime? // Termin tarihi
  deadlineDays   Int? // Termin gün sayısı
  notes          String?   @db.Text // Açıklama/Notlar

  // ========================================
  // KADEME FİYATLANDIRMA (Tier Pricing)
  // ========================================
  priceBreaks Json? // Kademe fiyatları: { "tiers": [{"min": 100, "max": 500, "price": 12.5}, {"min": 501, "max": 1000, "price": 11.0}, {"min": 1001, "price": 9.5}] }

  // ========================================
  // PAKETLEME & ETİKETLEME (Standardized)
  // ========================================
  // Packaging Type (LibraryItem relation - Platform standardı: POLYBAG, CARTON, HANGER, etc.)
  packagingType    LibraryItem? @relation("CollectionPackagingType", fields: [packagingTypeId], references: [id])
  packagingTypeId  Int?
  packagingDetails String?      @db.Text // Ek paketleme talimatları (özel talepler)

  // Labeling Type (LibraryItem relation - Platform standardı: CUSTOMER_LABEL, NEUTRAL, HANG_TAG, etc.)
  labelingType    LibraryItem? @relation("CollectionLabelingType", fields: [labelingTypeId], references: [id])
  labelingTypeId  Int?
  labelingDetails String?      @db.Text // Ek etiket talimatları (özel talepler)

  // ========================================
  // ÖDEME KOŞULLARI (Standardized)
  // ========================================
  // Payment Terms (LibraryItem relation - Platform standardı: 30 Days Net, 50/50, LC, TT, etc.)
  paymentTerms      LibraryItem? @relation("CollectionPaymentTerms", fields: [paymentTermsId], references: [id])
  paymentTermsId    Int?
  depositRequired   Boolean      @default(false) // Ön ödeme gerekli mi?
  depositPercentage Float? // Ön ödeme oranı (%30, %50, vb.) - Esnek alan

  // ========================================
  // KALİTE STANDARTLARI (Standardized)
  // ========================================
  // Quality Standard (LibraryItem relation - Platform standardı: AQL 2.5, AQL 4.0, ZERO_DEFECT, etc.)
  qualityStandard   LibraryItem? @relation("CollectionQualityStandard", fields: [qualityStandardId], references: [id])
  qualityStandardId Int?
  defectTolerance   Float? // İzin verilen hata oranı (örn: 2.5 = %2.5 AQL) - Sayısal veri

  // ========================================
  // ACİL SİPARİŞ SEÇENEKLERİ
  // ========================================
  rushOrderAvailable Boolean @default(false) // Hızlı üretim mümkün mü?
  rushOrderExtraCost Float? // Acil sipariş ek maliyeti (% olarak)
  rushOrderMinDays   Int? // Minimum hızlı üretim süresi (gün)

  // Sertifikalar (GOTS, OEKO-TEX, BSCI vb.) - Artık LibraryItem üzerinden
  certifications LibraryItem[] @relation("CollectionCertifications")

  // ========================================
  // REVİZE/ÖZELLEŞTİRME SİSTEMİ
  // RFQ sistemi zaten tam özelleştirme sağlıyor (customerBrief, targetBudget, vb.)
  // Sample sistemi revize talepleri için kullanılıyor (SampleType.REVISION)
  // ========================================

  // ========================================
  // KAPASITE VE NUMUNE POLİTİKASI
  // ========================================
  monthlyCapacity  Int? // Aylık üretim kapasitesi (adet)
  maxOrderQuantity Int? // Maksimum sipariş miktarı (adet)

  // ========================================
  // SİPARİŞ POLİTİKASI (Order Policy)
  // ========================================
  allowDirectOrder Boolean @default(true) // Numune olmadan sipariş alınır mı?
  requireSample    Boolean @default(false) // Numune zorunlu mu? (özel/karmaşık ürünler için)
  samplePolicy     String? @default("OPTIONAL") // "REQUIRED", "OPTIONAL", "NOT_AVAILABLE"
  sampleLeadTime   Int?    @default(7) // Numune üretim süresi (gün)
  samplePrice      Float?  @default(0) // Numune birim fiyatı (0 = ücretsiz)

  // ========================================
  // YENİ: Library Item Relations
  // ========================================
  // Varsayılan beden dağılımı (SIZE_BREAKDOWN)
  defaultSizeBreakdown   LibraryItem? @relation("CollectionSizeBreakdown", fields: [defaultSizeBreakdownId], references: [id])
  defaultSizeBreakdownId Int?

  // Baskı/desen tipleri (PRINT) - Many-to-many
  prints LibraryItem[] @relation("CollectionPrints")

  // Yıkama efekti (WASH_EFFECT)
  washEffect   LibraryItem? @relation("CollectionWashEffect", fields: [washEffectId], references: [id])
  washEffectId Int?

  // ========================================
  // ANALYTICS & ENGAGEMENT
  // ========================================
  viewCount    Int       @default(0) // Görüntülenme sayısı
  shareCount   Int       @default(0) // Paylaşım sayısı
  lastViewedAt DateTime? // Son görüntülenme zamanı

  // Status flags
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  // Production Schedule - Her aşama için standart gün sayısı
  productionSchedule Json? // { "PLANNING": 5, "FABRIC": 3, "CUTTING": 2, "SEWING": 10, "QUALITY": 2, "PACKAGING": 2, "SHIPPING": 1 }

  // Admin tarafından belirlenen standart kategori
  category   Category? @relation("CollectionCategory", fields: [categoryId], references: [id])
  categoryId Int?

  author   User? @relation(fields: [authorId], references: [id]) // Üretici
  authorId Int?

  // Relations
  samples        Sample[]   @relation("SampleCollection")
  revisedSamples Sample[]   @relation("OriginalCollection") // Bu ürün için yapılan revize numuneleri
  orders         Order[]
  questions      Question[]

  // Company relation
  company   Company? @relation(fields: [companyId], references: [id])
  companyId Int?

  // ========================================
  // MÜŞTERİ RFQ SİSTEMİ (Customer Request for Quotation)
  // ========================================
  ownerType CollectionOwnerType @default(MANUFACTURER) // Sahibi: Üretici mi Müşteri mi?

  // Müşteri RFQ Bilgileri (ownerType=CUSTOMER ise dolu)
  customerBrief   String? @db.Text // Müşteri açıklaması (basit, teknik olmayan)
  referenceImages String? @db.Text // JSON array: Referans görseller
  sketchUrl       String? // Müşteri taslak tasarımı

  // Müşteri Hedef Bilgileri
  targetBudget       Float? // Hedef birim fiyat (USD)
  targetQuantity     Int? // Hedef sipariş miktarı
  targetDeliveryDays Int? // Hedef termin süresi (gün)

  // RFQ Durum Yönetimi
  isRFQ       Boolean    @default(false) // Bu bir RFQ mü?
  rfqStatus   RFQStatus? // RFQ durumu
  rfqDeadline DateTime? // Teklif son tarihi
  rfqWinnerId Int? // Seçilen kazanan üretici ID
  rfqWinner   User?      @relation("RFQWinner", fields: [rfqWinnerId], references: [id])

  // RFQ Görünürlük Kontrolü
  visibility           CollectionVisibility @default(PRIVATE) // PRIVATE, INVITED, PUBLIC
  invitedManufacturers Json? // Davet edilen üretici ID'leri: [123, 456, 789]

  // Üreticilerden gelen teklifler
  quotes CollectionQuote[]

  // ✅ OPTIMIZED INDEXES
  @@index([companyId, isActive, createdAt]) // Composite: firma koleksiyonları
  @@index([seasonId, gender, isActive]) // Sezon + cinsiyet filtreleme (seasonId scalar field)
  @@index([fitId, gender, isActive]) // Fit + cinsiyet filtreleme
  @@index([trendId, isActive]) // Trend bazlı filtreleme
  @@index([isFeatured, isActive]) // Öne çıkan koleksiyonlar
  @@index([packagingTypeId, isActive]) // Paketleme tipi filtreleme
  @@index([qualityStandardId, isActive]) // Kalite standardı filtreleme
  @@index([paymentTermsId, isActive]) // Ödeme koşulu filtreleme
  @@index([modelCode])
  @@index([viewCount])
  @@index([ownerType, isRFQ, visibility, isActive]) // RFQ marketplace filtreleme
  @@index([rfqStatus, rfqDeadline]) // RFQ durum ve termin bazlı sorgular
  @@fulltext([name, description])
  @@map("collections")
}

// ========================================
// KOLEKSİYON TEKLİF YÖNETİMİ (Collection Quote Management)
// Müşteri RFQ'leri için üretici teklifleri
// ========================================
model CollectionQuote {
  id           Int        @id @default(autoincrement())
  collectionId Int
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)

  manufactureId Int
  manufacture   User @relation("ManufacturerQuotes", fields: [manufactureId], references: [id])

  // ========================================
  // TEKLİF DETAYLARI
  // ========================================
  unitPrice      Float // Teklif edilen birim fiyat
  currency       String @default("USD") // Para birimi
  moq            Int // Minimum sipariş miktarı (MOQ)
  productionDays Int // Üretim süresi (gün)

  // Numune bilgileri
  sampleDays  Int?   @default(7) // Numune üretim süresi (gün)
  samplePrice Float? @default(0) // Numune birim fiyatı

  // ========================================
  // TEKNİK BİLGİLER & ÖNERİLER
  // ========================================
  notes           String? @db.Text // Genel notlar
  technicalNotes  String? @db.Text // Teknik açıklamalar/öneriler
  suggestedFabric String? @db.Text // Önerilen kumaş detayları
  suggestedPrint  String? @db.Text // Önerilen baskı/desen
  suggestedFinish String? @db.Text // Önerilen yıkama/finish işlemleri

  // Sertifikalar (JSON array: ["GOTS", "OEKO-TEX", "BSCI"])
  certifications String? @db.Text

  // Portföy görselleri (JSON array: ["/uploads/...", "..."])
  portfolioImages String? @db.Text

  // ========================================
  // TEKLİF DURUMU
  // ========================================
  status   QuoteStatus @default(PENDING)
  isWinner Boolean     @default(false) // Kazanan teklif mi?

  // ========================================
  // MÜŞTERİ DEĞERLENDİRMESİ
  // ========================================
  customerNote   String? @db.Text // Müşteri notu (teklif hakkında)
  customerRating Int? // Müşteri değerlendirmesi (1-5 yıldız)

  // ========================================
  // İLİŞKİLER (Quote → Sample → Order akışı)
  // ========================================
  sampleRequested Boolean @default(false) // Numune talep edildi mi?
  sampleId        Int?    @unique // İlgili numune
  sample          Sample? @relation("QuoteSample", fields: [sampleId], references: [id])

  orderId Int?   @unique // İlgili sipariş (numune sonrası)
  order   Order? @relation("QuoteOrder", fields: [orderId], references: [id])

  // ========================================
  // ZAMAN BİLGİLERİ
  // ========================================
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime? // Teklif son geçerlilik tarihi

  @@unique([collectionId, manufactureId]) // Her koleksiyon için her üreticiden 1 teklif
  @@index([collectionId, status]) // Koleksiyon tekliflerini filtreleme
  @@index([manufactureId, status]) // Üretici tekliflerini filtreleme
  @@index([isWinner])
  @@map("collection_quotes")
}

// Numune talep ve üretim sistemi
model Sample {
  id                   Int          @id @default(autoincrement())
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt
  sampleNumber         String       @unique // Numune takip numarası
  sampleType           SampleType   @default(STANDARD) // Numune tipi
  status               SampleStatus @default(REQUESTED)
  customerNote         String?      @db.Text // Müşteri talep notu
  manufacturerResponse String?      @db.Text // Üretici yanıtı/değerlendirme

  // Revize/Özelleştirme bilgileri (CUSTOM ve REVISION tipleri için)
  customDesignImages   String? @db.Text // Müşteri tasarım görselleri (JSON)
  revisionRequests     String? // Revize istekleri (JSON: [{field, oldValue, newValue, note}])
  originalCollectionId Int? // Revize edilecek orijinal ürün ID'si

  // AI Generated Sample fields
  name        String? // Sample name
  description String?  @db.Text // Sample description (long text)
  images      String?  @db.Text // JSON array of image URLs
  aiGenerated Boolean? @default(false) // Is this an AI-generated sample
  aiPrompt    String?  @db.Text // The prompt used for AI generation
  aiSketchUrl String? // The sketch/reference image URL used

  // Üretim süreci bilgileri
  unitPrice               Float? // Numune birim fiyatı
  productionDays          Int? // Üretici: "X günde üretebilirim"
  estimatedProductionDate DateTime? // Hesaplanan üretim tarihi
  actualProductionDate    DateTime? // Gerçek üretim tamamlanma tarihi
  shippingDate            DateTime? // Kargoya veriliş tarihi
  deliveryAddress         String? // Teslimat adresi
  cargoTrackingNumber     String? // Kargo takip numarası (opsiyonel)

  // Müşteri Teklif Bilgileri (Order ile aynı)
  customerQuotedPrice Float? // Müşterinin teklif ettiği fiyat
  customerQuoteDays   Int? // Müşterinin istediği üretim süresi (gün)
  customerQuoteNote   String?   @db.Text // Müşterinin teklif notu/açıklaması
  customerQuoteType   String? // "STANDARD" (standartlara uygun) veya "REVISION" (revize teklif)
  customerQuoteSentAt DateTime? // Müşteri teklifi gönderme zamanı

  collection         Collection?          @relation("SampleCollection", fields: [collectionId], references: [id])
  collectionId       Int?
  originalCollection Collection?          @relation("OriginalCollection", fields: [originalCollectionId], references: [id])
  customer           User                 @relation("CustomerSamples", fields: [customerId], references: [id])
  customerId         Int
  manufacture        User                 @relation("ManufactureSamples", fields: [manufactureId], references: [id])
  manufactureId      Int
  productionHistory  SampleProduction[] // Üretim geçmişi takibi
  productionTracking ProductionTracking[]
  messages           Message[] // Numune bazlı mesajlaşma

  // Company relation
  company   Company? @relation(fields: [companyId], references: [id])
  companyId Int?

  // Notifications
  notifications Notification[] @relation("SampleNotifications")

  // Beden talepleri
  requestedSizes SampleSizeRequest[]

  // ========================================
  // REVERSE RELATION: Bu numune sonrası verilen siparişler
  // ========================================
  resultingOrders Order[] @relation("OrderBasedOnSample")

  // ========================================
  // REVERSE RELATION: Bu numune ile ilgili teklif
  // ========================================
  relatedQuote CollectionQuote? @relation("QuoteSample")

  @@index([status])
  @@index([customerId, status])
  @@index([manufactureId, status])
  @@index([companyId, status, createdAt])
  @@index([collectionId])
  @@index([sampleNumber])
  @@index([sampleType, status])
  @@index([aiGenerated])
  @@index([createdAt])
  @@index([status, createdAt])
  @@map("samples")
}

// Numune üretim geçmişi takibi
model SampleProduction {
  id            Int          @id @default(autoincrement())
  createdAt     DateTime     @default(now())
  status        SampleStatus
  note          String? // Üretici açıklaması
  estimatedDays Int? // Bu aşama için tahmini gün
  actualDate    DateTime? // Bu aşamanın gerçek tamamlanma tarihi
  sample        Sample       @relation(fields: [sampleId], references: [id])
  sampleId      Int
  updatedBy     User         @relation(fields: [updatedById], references: [id])
  updatedById   Int
}

// Sipariş ve üretim sistemi
model Order {
  id                   Int         @id @default(autoincrement())
  createdAt            DateTime    @default(now())
  updatedAt            DateTime    @updatedAt
  orderNumber          String      @unique
  quantity             Int
  unitPrice            Float // Birim fiyat
  totalPrice           Float // Toplam fiyat
  targetPrice          Float? // Hedef birim fiyat (müşteri beklentisi)
  currency             String?     @default("USD") // Para birimi
  deadline             DateTime? // İstenen teslimat tarihi
  notes                String?     @db.Text // Genel sipariş notları
  status               OrderStatus @default(PENDING)
  customerNote         String? // Müşteri sipariş notu
  manufacturerResponse String? // Üretici yanıtı/değerlendirme

  // Müşteri Teklif Bilgileri
  customerQuotedPrice Float? // Müşterinin teklif ettiği birim fiyat
  customerQuoteDays   Int? // Müşterinin istediği üretim süresi (gün)
  customerQuoteNote   String?   @db.Text // Müşterinin teklif notu/açıklaması
  customerQuoteType   String? // "STANDARD" (standartlara uygun) veya "REVISION" (revize teklif)
  customerQuoteSentAt DateTime? // Müşteri teklifi gönderme zamanı

  // Üretim süreci bilgileri
  productionDays          Int? // Üretici: "X günde üretebilirim"
  estimatedProductionDate DateTime? // Hesaplanan üretim tarihi
  actualProductionStart   DateTime? // Gerçek üretime başlama tarihi
  actualProductionEnd     DateTime? // Gerçek üretim bitiş tarihi
  shippingDate            DateTime? // Kargoya veriliş tarihi
  deliveryAddress         String? // Teslimat adresi
  cargoTrackingNumber     String? // Kargo takip numarası

  // ============================================
  // PAZARLIK SİSTEMİ (Negotiation)
  // OrderNegotiation modeli tüm pazarlık geçmişini detaylı tutuyor
  // ============================================

  // ========================================
  // NUMUNE İLİŞKİSİ (Sample Relationship)
  // ========================================
  basedOnSample   Sample? @relation("OrderBasedOnSample", fields: [basedOnSampleId], references: [id])
  basedOnSampleId Int? // Hangi numune onaylandı? (NULL = direkt sipariş)
  orderType       String  @default("DIRECT") // "DIRECT" (katalog) veya "CUSTOM" (numune sonrası)

  // ✅ DENORMALIZED CACHE (hızlı liste görünümü için)
  collectionName      String? // Collection adı cache
  collectionImage     String? // Collection ilk görseli cache
  collectionModelCode String? // Collection model kodu cache

  collection         Collection          @relation(fields: [collectionId], references: [id])
  collectionId       Int
  customer           User                @relation("CustomerOrders", fields: [customerId], references: [id])
  customerId         Int
  manufacture        User                @relation("ManufactureOrders", fields: [manufactureId], references: [id])
  manufactureId      Int
  productionHistory  OrderProduction[] // Üretim süreç takibi
  productionTracking ProductionTracking? // Her sipariş için tek üretim planı
  messages           Message[] // Sipariş bazlı mesajlaşma

  // Company relation
  company   Company? @relation(fields: [companyId], references: [id])
  companyId Int?

  // Notifications
  notifications Notification[] @relation("OrderNotifications")

  // Pazarlık
  negotiations OrderNegotiation[]

  // Değişiklik takibi
  changeLogs OrderChangeLog[]

  // Beden dağılımı
  sizeBreakdown OrderSizeBreakdown[]

  // Ödemeler
  payments Payment[]

  // ========================================
  // REVERSE RELATION: Bu siparişin teklif kaynağı
  // ========================================
  relatedQuote CollectionQuote? @relation("QuoteOrder")

  // ========================================
  // DEĞERLENDİRME/RATING SİSTEMİ
  // ========================================
  review OrderReview? @relation("OrderReview")

  @@index([orderNumber])
  @@index([status])
  @@index([customerId, status])
  @@index([manufactureId, status])
  @@index([companyId, status, createdAt])
  @@index([collectionId])
  @@index([basedOnSampleId]) // Numune bazlı siparişler
  @@index([orderType, status]) // Sipariş tipi filtreleme
  @@map("orders")
}

// ============================================
// SİPARİŞ DEĞERLENDİRME SİSTEMİ (Order Review/Rating)
// Müşteriler teslim edilen siparişler için değerlendirme yapabilir
// ============================================
model OrderReview {
  id      Int   @id @default(autoincrement())
  orderId Int   @unique
  order   Order @relation("OrderReview", fields: [orderId], references: [id], onDelete: Cascade)

  // Değerlendiren müşteri
  customerId Int
  customer   User @relation("CustomerReviews", fields: [customerId], references: [id])

  // Değerlendirilen üretici
  manufactureId Int
  manufacture   User @relation("ManufacturerReviews", fields: [manufactureId], references: [id])

  // Değerlendirme puanları (1-5 yıldız)
  rating              Int // Genel puan (1-5)
  qualityRating       Int? // Kalite puanı (1-5)
  deliveryRating      Int? // Teslimat puanı (1-5)
  communicationRating Int? // İletişim puanı (1-5)

  // Yorum
  comment String? @db.Text

  // Üreticinin yanıtı (opsiyonel)
  manufacturerReply     String?   @db.Text
  manufacturerRepliedAt DateTime?

  // Durum
  isPublic   Boolean @default(true) // Herkese açık mı?
  isApproved Boolean @default(true) // Admin onayı (spam/hakaret kontrolü)

  // Faydalı mı? (Diğer kullanıcılar için)
  helpfulCount   Int @default(0) // "Bu yorum yararlı" sayısı
  unhelpfulCount Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId])
  @@index([customerId, rating])
  @@index([manufactureId, rating])
  @@index([rating, isPublic, isApproved])
  @@index([createdAt])
  @@map("order_reviews")
}

// ============================================
// PAZARLIK SİSTEMİ (Order Negotiation)
// ============================================
model OrderNegotiation {
  id      Int @id @default(autoincrement())
  orderId Int

  // Teklif veren
  senderId   Int
  senderRole String // "CUSTOMER" veya "MANUFACTURER"

  // Teklif detayları
  unitPrice      Float // Teklif edilen birim fiyat (USD/adet)
  productionDays Int // Teklif edilen üretim süresi (gün)
  quantity       Int? // Teklif edilen koleksiyon adeti (opsiyonel, değişiklik varsa)
  currency       String @default("USD")

  // Mesaj
  message String? @db.Text

  // Durum
  status String @default("PENDING") // PENDING, ACCEPTED, REJECTED, SUPERSEDED

  // Yanıt
  respondedAt DateTime?
  respondedBy Int?

  createdAt DateTime @default(now())

  // İlişkiler
  order     Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  sender    User  @relation("SentNegotiations", fields: [senderId], references: [id])
  responder User? @relation("RespondedNegotiations", fields: [respondedBy], references: [id])

  // Order değişiklik ile ilişki
  relatedChangeLog OrderChangeLog?

  @@index([orderId, createdAt])
  @@index([status])
  @@map("order_negotiations")
}

// ============================================
// SİPARİŞ DEĞİŞİKLİK TAKİP SİSTEMİ
// ============================================
model OrderChangeLog {
  id        Int @id @default(autoincrement())
  orderId   Int
  changedBy Int // Değişikliği yapan kullanıcı

  // Değişiklik tipi
  changeType String // "QUANTITY", "PRICE", "DEADLINE", "NOTES", "FULL_UPDATE"

  // Eski değerler (JSON olarak)
  previousValues Json // { "quantity": 100, "unitPrice": 25.50, "deadline": "2024-01-15" }

  // Yeni değerler (JSON olarak)
  newValues Json // { "quantity": 150, "unitPrice": 23.00, "deadline": "2024-01-20" }

  // Değişiklik açıklaması
  changeReason String? @db.Text // "Müşteri miktarı artırmak istiyor"

  // Üretici yanıtı durumu
  manufacturerStatus String @default("PENDING") // PENDING, REVIEWED, ACCEPTED, REJECTED, NEGOTIATED

  // Üretici yanıtı
  manufacturerResponse   String?   @db.Text
  manufacturerReviewedAt DateTime?
  manufacturerReviewedBy Int?

  // Pazarlık başlatılır
  negotiationTriggered Boolean @default(false)
  negotiationId        Int?    @unique

  createdAt DateTime @default(now())

  // İlişkiler
  order              Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  changedByUser      User              @relation("OrderChangesMade", fields: [changedBy], references: [id])
  reviewedByUser     User?             @relation("OrderChangesReviewed", fields: [manufacturerReviewedBy], references: [id])
  relatedNegotiation OrderNegotiation? @relation(fields: [negotiationId], references: [id])

  @@index([orderId, createdAt])
  @@index([manufacturerStatus])
  @@index([changeType])
  @@map("order_change_logs")
}

// ============================================
// ÖDEME SİSTEMİ (Payment System)
// ============================================
enum PaymentType {
  DEPOSIT // Ön ödeme / Kapora (%30, %50 vb.)
  PROGRESS // Ara ödeme (üretim aşamasında)
  BALANCE // Kalan ödeme (sevkiyat öncesi)
  FULL // Peşin ödeme (tüm tutar)
}

enum PaymentStatus {
  PENDING // Ödeme bekleniyor
  RECEIPT_UPLOADED // Dekont yüklendi, onay bekleniyor
  CONFIRMED // Ödeme onaylandı
  REJECTED // Dekont reddedildi
  OVERDUE // Ödeme gecikmiş
  CANCELLED // İptal edildi
}

enum PaymentMethod {
  BANK_TRANSFER // Banka havalesi (EFT/SWIFT)
  WIRE_TRANSFER // Havale
  CHECK // Çek
  CASH // Nakit (nadiren)
  OTHER // Diğer
}

model Payment {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Ödeme Detayları
  type   PaymentType
  status PaymentStatus @default(PENDING)
  method PaymentMethod @default(BANK_TRANSFER)

  // Tutar Bilgileri
  amount     Float // Ödeme tutarı (USD/TRY)
  currency   String @default("USD")
  percentage Float? // Toplam tutarın yüzdesi (%30, %50 vb.)

  // Banka Dekontu
  receiptUrl        String?   @db.Text // Dekont dosya yolu
  receiptUploadedAt DateTime? // Dekont yüklenme zamanı
  receiptUploadedBy Int? // Dekontu yükleyen kullanıcı (müşteri)

  // Onay Bilgileri
  confirmedAt     DateTime? // Ödeme onay zamanı
  confirmedBy     Int? // Onaylayan kullanıcı (üretici)
  rejectionReason String?   @db.Text // Red sebebi

  // Vade Bilgileri
  dueDate  DateTime? // Ödeme vadesi
  paidDate DateTime? // Ödeme gerçekleşme tarihi

  // Notlar
  description String? @db.Text // Ödeme açıklaması
  notes       String? @db.Text // Ek notlar (müşteri/üretici)

  // Banka Bilgileri (opsiyonel - ödeme detayları için)
  bankName      String? // Banka adı
  accountHolder String? // Hesap sahibi
  transactionId String? // İşlem referans numarası

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderId, status])
  @@index([status, dueDate])
  @@index([type])
  @@map("payments")
}

// ============================================
// BEDEN DAĞILIMI SİSTEMİ (Size Breakdown)
// ============================================
// Sipariş beden dağılımı (örn: XS:10%, S:25%, M:35%, L:20%, XL:10%)
model OrderSizeBreakdown {
  id      Int   @id @default(autoincrement())
  orderId Int
  order   Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Beden bilgisi
  size       String // "XS", "S", "M", "L", "XL", "2XL", "3XL"
  quantity   Int // Bu bedenden kaç adet (örn: 350 adet M beden)
  percentage Float // Yüzde dağılımı (örn: 35 = %35)

  // Üretim takibi
  produced Int @default(0) // Üretilmiş miktar
  packed   Int @default(0) // Paketlenmiş miktar
  shipped  Int @default(0) // Kargoya verilmiş miktar

  // Notlar
  notes String? @db.Text // Beden için özel notlar

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([orderId, size]) // Her sipariş için her beden sadece bir kez
  @@index([orderId])
  @@index([size])
  @@map("order_size_breakdowns")
}

// Numune beden talepleri (müşteri hangi bedenleri istiyor)
model SampleSizeRequest {
  id       Int    @id @default(autoincrement())
  sampleId Int
  sample   Sample @relation(fields: [sampleId], references: [id], onDelete: Cascade)

  // Beden bilgisi
  size String // "XS", "S", "M", "L", "XL"

  createdAt DateTime @default(now())

  @@unique([sampleId, size]) // Her numune için her beden sadece bir kez
  @@index([sampleId])
  @@map("sample_size_requests")
}

// Sipariş üretim geçmişi takibi
model OrderProduction {
  id            Int         @id @default(autoincrement())
  createdAt     DateTime    @default(now())
  status        OrderStatus
  note          String? // Üretici açıklaması
  estimatedDays Int? // Bu aşama için tahmini gün
  actualDate    DateTime? // Bu aşamanın gerçek tamamlanma tarihi
  order         Order       @relation(fields: [orderId], references: [id])
  orderId       Int
  updatedBy     User        @relation("OrderProductionUpdates", fields: [updatedById], references: [id])
  updatedById   Int
}

// Soru-cevap sistemi
model Question {
  id            Int        @id @default(autoincrement())
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  question      String
  answer        String?
  isAnswered    Boolean    @default(false)
  isPublic      Boolean    @default(true) // Herkese görünür mü?
  collection    Collection @relation(fields: [collectionId], references: [id])
  collectionId  Int
  customer      User       @relation("CustomerQuestions", fields: [customerId], references: [id])
  customerId    Int
  manufacture   User       @relation("ManufactureQuestions", fields: [manufactureId], references: [id])
  manufactureId Int
}

// Enum'lar
enum SampleType {
  STANDARD // Mevcut ürün için standart numune
  REVISION // Mevcut ürün için revize istekli numune
  CUSTOM // Müşteri kendi tasarımı için numune
  DEVELOPMENT // Mevcut veriler için backward compatibility
}

enum SampleStatus {
  // === İLK AŞAMALAR (AI ve Talep) ===
  AI_DESIGN // AI ile oluşturulmuş tasarım (henüz üreticiye gönderilmedi)
  PENDING_APPROVAL // Üretici onayı bekleniyor (eski flow için)
  PENDING // Beklemede - Yeni talep

  // === İNCELEME ve TEKLİF AŞAMASI ===
  REVIEWED // Üretici tarafından inceleniyor
  QUOTE_SENT // Üretici süre ve fiyat teklifi gönderdi
  CUSTOMER_QUOTE_SENT // Müşteri teklif gönderdi (standart veya revize)
  MANUFACTURER_REVIEWING_QUOTE // Üretici müşteri teklifini inceliyor

  // === ONAY/RED DURUMLAR ===
  CONFIRMED // Müşteri onayladı, üretim başlayabilir
  REJECTED // Genel red
  REJECTED_BY_CUSTOMER // Müşteri tarafından reddedildi
  REJECTED_BY_MANUFACTURER // Üretici tarafından reddedildi

  // === ÜRETİM AŞAMALARI ===
  IN_DESIGN // Tasarım aşamasında (eski flow)
  PATTERN_READY // Kalıp hazır (eski flow)
  IN_PRODUCTION // Üretim aşamasında
  PRODUCTION_COMPLETE // Üretim tamamlandı

  // === KALİTE ve TESLİMAT ===
  QUALITY_CHECK // Kalite kontrolde
  SHIPPED // Kargoya verildi
  DELIVERED // Müşteriye teslim edildi

  // === DİĞER DURUMLAR ===
  ON_HOLD // Durduruldu (geçici olarak askıya alındı)
  CANCELLED // İptal edildi

  // === ESKİ FLOW İÇİN (Geriye dönük uyumluluk) ===
  REQUESTED // Müşteri tarafından talep edildi (eski)
  RECEIVED // Üretici talebi aldı (eski)
  COMPLETED // Tamamlandı (eski - artık DELIVERED kullanılıyor)
}

enum OrderStatus {
  // ========================================
  // AŞAMA 1: Sipariş Talebi ve İnceleme
  // ========================================
  PENDING // Yeni sipariş talebi (müşteriden geldi)
  REVIEWED // Üretici tarafından inceleniyor

  // ========================================
  // AŞAMA 2: Fiyat ve Süre Pazarlığı
  // ========================================
  QUOTE_SENT // Üretici fiyat/süre teklifi gönderdi
  CUSTOMER_QUOTE_SENT // Müşteri karşı teklif gönderdi
  MANUFACTURER_REVIEWING_QUOTE // Üretici karşı teklifi değerlendiriyor
  QUOTE_AGREED // Fiyat ve sürede anlaşma sağlandı

  // ========================================
  // AŞAMA 3: Sipariş Onayı
  // ========================================
  CONFIRMED // Müşteri siparişi kesinleştirdi (ödeme bekleniyor)
  DEPOSIT_PENDING // Kapora ödemesi bekleniyor
  DEPOSIT_RECEIVED // Kapora alındı, üretim planı hazırlanacak

  // ========================================
  // AŞAMA 4: Üretim Planlaması
  // ========================================
  PRODUCTION_PLAN_PREPARING // Üretici üretim planı hazırlıyor
  PRODUCTION_PLAN_SENT // Üretim planı müşteriye gönderildi (onay bekleniyor)
  PRODUCTION_PLAN_APPROVED // Müşteri üretim planını onayladı (üretim başlayabilir)
  PRODUCTION_PLAN_REJECTED // Müşteri planı reddetti (revizyon gerekli)

  // ========================================
  // AŞAMA 5: Üretim Süreci
  // ========================================
  IN_PRODUCTION // Üretim başladı (aşamalar takip ediliyor)
  PRODUCTION_COMPLETE // Üretim tamamlandı
  QUALITY_CHECK // Kalite kontrol yapılıyor
  QUALITY_APPROVED // Kalite kontrol geçti
  QUALITY_FAILED // Kalite kontrol başarısız (revizyon gerekli)

  // ========================================
  // AŞAMA 6: Sevkiyat ve Teslimat
  // ========================================
  READY_TO_SHIP // Sevkiyata hazır (kalan ödeme bekleniyor)
  BALANCE_PENDING // Kalan ödeme bekleniyor
  BALANCE_RECEIVED // Kalan ödeme alındı
  SHIPPED // Kargoya verildi
  IN_TRANSIT // Yolda
  DELIVERED // Müşteriye teslim edildi

  // ========================================
  // AŞAMA 7: Red ve İptal Durumları
  // ========================================
  REJECTED // Genel red
  REJECTED_BY_CUSTOMER // Müşteri tarafından reddedildi
  REJECTED_BY_MANUFACTURER // Üretici tarafından reddedildi
  CANCELLED // İptal edildi
  ON_HOLD // Askıya alındı (geçici durduruldu)
}

model File {
  id          String   @id @default(cuid())
  filename    String
  path        String
  size        Int
  mimetype    String
  encoding    String?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("files")
}

// Production Stage Updates
model ProductionStageUpdate {
  id           Int                @id @default(autoincrement())
  production   ProductionTracking @relation(fields: [productionId], references: [id], onDelete: Cascade)
  productionId Int

  stage           ProductionStage
  status          StageStatus     @default(NOT_STARTED)
  actualStartDate DateTime?
  actualEndDate   DateTime?
  estimatedDays   Int?
  notes           String?         @db.Text
  photos          String?         @db.Text // JSON array
  isRevision      Boolean         @default(false)
  delayReason     String?         @db.Text // Gecikme sebebi
  extraDays       Int             @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("production_stage_updates")
}

// ========================================
// UNIFIED LIBRARY SYSTEM (Simplified & Scalable)
// ========================================

enum LibraryCategory {
  COLOR // Renk paleti
  FABRIC // Kumaş kütüphanesi
  MATERIAL // Aksesuar/Malzemeler (Button, Zipper, Label, etc.)
  SIZE_GROUP // Beden grupları
  SEASON // Sezon yönetimi
  FIT // Kesim tipleri
  CERTIFICATION // Sertifikalar
  SIZE_BREAKDOWN // Beden dağılım şablonları (XS:10%, S:25%, M:35%, L:20%, XL:10%)
  PRINT // Baskı/desen tipleri (Dijital, Silkscreen, Transfer, Nakış)
  WASH_EFFECT // Yıkama efektleri (Stone Wash, Acid Wash, Vintage, Raw)
  TREND // Trend/Stil kütüphanesi (Minimalist, Vintage, Sport Chic, Y2K, Cottagecore)

  // ========================================
  // YENİ: Ticari Standartlar (B2B)
  // ========================================
  PACKAGING_TYPE // Paketleme standartları (POLYBAG, CARTON, HANGER, GIFT_BOX)
  QUALITY_STANDARD // Kalite standartları (AQL 2.5, AQL 4.0, ZERO_DEFECT, ISO 9001)
  PAYMENT_TERMS // Ödeme koşulları (30 Days Net, 50/50, LC, TT, Cash)
  LABELING_TYPE // Etiketleme tipleri (CUSTOMER_LABEL, NEUTRAL, MANUFACTURER, HANG_TAG)
}

enum LibraryScope {
  PLATFORM_STANDARD // Platform geneli standart (admin tanımlı)
  COMPANY_CUSTOM // Firma özel
}

// Unified Library Item - Tüm library tiplerini kapsayan tek model
model LibraryItem {
  id       Int             @id @default(autoincrement())
  scope    LibraryScope    @default(COMPANY_CUSTOM)
  category LibraryCategory

  // Universal Fields (Her kategori için ortak)
  code String? @unique
  name String // i18n key or direct name (frontend handles translations)

  description String? @db.Text
  imageUrl    String? @db.Text // PNG/SVG for all categories (COLOR swatch, CERTIFICATION logo, PRINT sample, etc.)

  // 🔍 Filtreleme için kritik alanlar (normalized - Hybrid Approach)
  // FIT ve SIZE_GROUP kategorileri için hızlı query
  gender       String? // MEN, WOMEN, BOYS, GIRLS, UNISEX
  fitCategory  String? // TOP, BOTTOM, DRESS, OUTERWEAR  
  sizeCategory String? // TOP, BOTTOM, DRESS, OUTERWEAR, KIDS

  // ✅ FABRIC için sık sorgulanan alanlar (OPTIMIZED)
  fiberType    String? // COTTON, POLYESTER, WOOL, LINEN, SILK, BLEND
  fabricWeight Int? // Kumaş ağırlığı (gram/m²)
  fabricWidth  Int? // Kumaş eni (cm)

  // ✅ MATERIAL için sık sorgulanan alanlar (OPTIMIZED)
  materialType String? // BUTTON, ZIPPER, LABEL, THREAD, TRIM, ELASTIC

  // ✅ COLOR için sık sorgulanan alanlar (OPTIMIZED)
  hexColor    String? // #FFFFFF
  colorFamily String? // NEUTRAL, WARM, COOL, EARTH, PASTEL, BRIGHT

  // Category-Specific Data (JSON - Detaylı bilgiler için)
  // ⚠️ FABRIC/MATERIAL price data should be in data.price, not top-level
  data Json?

  // Common Metadata
  notes String? @db.Text

  // Status
  isActive  Boolean @default(true)
  isPopular Boolean @default(false)

  // Relations
  company   Company? @relation("CompanyLibraryItems", fields: [companyId], references: [id], onDelete: Cascade)
  companyId Int?

  // Standard Reference (Company items can reference platform standards)
  standardItem   LibraryItem?  @relation("StandardReference", fields: [standardItemId], references: [id])
  standardItemId Int?
  companyItems   LibraryItem[] @relation("StandardReference")

  // 🔗 Certification Relations (Many-to-Many)
  // Bu item'ın sahip olduğu sertifikalar (Fabric/Color/Material → Certifications)
  certifications LibraryItem[] @relation("ItemCertifications")
  // Bu sertifikanın atandığı item'lar (Certification → Fabric/Color/Material)
  certifiedItems LibraryItem[] @relation("ItemCertifications")

  // Collections using certifications
  collections Collection[] @relation("CollectionCertifications")

  // ========================================
  // YENİ: Collection Relations (Reverse) - STANDARDIZATION
  // ========================================
  // SEASON için reverse relation (Platform standardı)
  collectionsWithSeason Collection[] @relation("CollectionSeason")

  // FIT için reverse relation (Platform standardı + Ölçü tablosu)
  collectionsWithFit Collection[] @relation("CollectionFit")

  // TREND için reverse relation (Platform standardı)
  collectionsWithTrend Collection[] @relation("CollectionTrend")

  // SIZE_BREAKDOWN için reverse relation
  collectionsWithSizeBreakdown Collection[] @relation("CollectionSizeBreakdown")

  // SIZE_GROUPS için reverse relation (Many-to-many - Platform beden grubu kataloğu)
  collectionsWithSizeGroups Collection[] @relation("CollectionSizeGroups")

  // PRINT için reverse relation (Many-to-many)
  collectionsWithPrint Collection[] @relation("CollectionPrints")

  // WASH_EFFECT için reverse relation
  collectionsWithWashEffect Collection[] @relation("CollectionWashEffect")

  // COLORS için reverse relation (Many-to-many - Platform renk kataloğu)
  collectionsWithColors Collection[] @relation("CollectionColors")

  // FABRICS için reverse relation (Many-to-many - Platform kumaş kataloğu)
  collectionsWithFabrics Collection[] @relation("CollectionFabrics")

  // ACCESSORIES için reverse relation (Many-to-many - Platform aksesuar kataloğu)
  collectionsWithAccessories Collection[] @relation("CollectionAccessories")

  // ========================================
  // YENİ: Ticari Standartlar İçin Reverse Relations
  // ========================================
  // PACKAGING_TYPE için reverse relation (Platform standardı)
  collectionsWithPackagingType Collection[] @relation("CollectionPackagingType")

  // LABELING_TYPE için reverse relation (Platform standardı)
  collectionsWithLabelingType Collection[] @relation("CollectionLabelingType")

  // PAYMENT_TERMS için reverse relation (Platform standardı)
  collectionsWithPaymentTerms Collection[] @relation("CollectionPaymentTerms")

  // QUALITY_STANDARD için reverse relation (Platform standardı)
  collectionsWithQualityStandard Collection[] @relation("CollectionQualityStandard")

  createdBy   User? @relation("LibraryItemCreator", fields: [createdById], references: [id])
  createdById Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ✅ OPTIMIZED INDEXES
  @@unique([companyId, category, name])
  @@index([scope, category, isActive]) // Composite: liste sorguları için
  @@index([companyId, category, isActive]) // Firma bazlı filtreleme
  @@index([category, fiberType, isActive]) // Kumaş tipi filtreleme
  @@index([category, materialType, isActive]) // Aksesuar tipi filtreleme
  @@index([category, colorFamily, isActive]) // Renk filtreleme
  @@index([gender, fitCategory, sizeCategory]) // FIT/SIZE_GROUP için composite
  @@index([standardItemId])
  @@index([code])
  @@fulltext([name, description])
  @@map("library_items")
}

// Production Enums
enum ProductionStage {
  PLANNING
  FABRIC // Kumaş Tedarik
  CUTTING // Kesim
  SEWING // Dikim
  PRESSING // Ütü ve Pres
  QUALITY // Kalite Kontrol
  PACKAGING // Paketleme
  SHIPPING // Sevkiyat Hazırlık
}

enum StageStatus {
  NOT_STARTED
  IN_PROGRESS
  ON_HOLD
  COMPLETED
  REQUIRES_REVISION
}

enum ProductionStatus {
  IN_PROGRESS
  WAITING
  BLOCKED
  COMPLETED
  CANCELLED
}

enum ApprovalStatus {
  DRAFT // Üretici henüz hazırlıyor
  PENDING // Müşteri onayı bekleniyor
  APPROVED // Müşteri onayladı
  REJECTED // Müşteri reddetti
  REVISION // Revizyon gerekiyor
}

// ========================================
// NOTIFICATION SYSTEM
// ========================================

enum NotificationType {
  ORDER // Sipariş bildirimleri
  SAMPLE // Numune bildirimleri
  MESSAGE // Mesaj bildirimleri
  PRODUCTION // Üretim bildirimleri
  QUALITY // Kalite kontrol bildirimleri
  SYSTEM // Sistem bildirimleri
  USER_MANAGEMENT // Kullanıcı yönetimi bildirimleri
  ORDER_UPDATE // Sipariş güncellemeleri
  ORDER_CHANGE_RESPONSE // Sipariş değişikliği yanıtları
}

model Notification {
  id      Int              @id @default(autoincrement())
  type    NotificationType
  title   String
  message String           @db.Text
  link    String? // İlgili sayfanın URL'i
  isRead  Boolean          @default(false)
  data    Json? // Ek veri (opsiyonel)
  // İlişkiler
  userId  Int
  user    User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  // İlgili kayıtlar (opsiyonel)
  orderId              Int?
  order                Order?              @relation("OrderNotifications", fields: [orderId], references: [id], onDelete: Cascade)
  sampleId             Int?
  sample               Sample?             @relation("SampleNotifications", fields: [sampleId], references: [id], onDelete: Cascade)
  productionTrackingId Int?
  productionTracking   ProductionTracking? @relation("ProductionNotifications", fields: [productionTrackingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

// ========================================
